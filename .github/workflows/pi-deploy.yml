name: Deploy to Raspberry Pi

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment regardless of branch'
        required: false
        default: 'false'

env:
  DEPLOY_USER: merk
  DEPLOY_HOST: ${{ secrets.PI_HOST }}
  DEPLOY_KEY: ${{ secrets.PI_SSH_KEY }}
  DOCKER_IMAGE: gcumerk/cst590-capstone-public:latest

jobs:
  validate:
    name: Validate Deployment Package
    runs-on: ubuntu-latest
    outputs:
      deployment-ready: ${{ steps.validation.outputs.ready }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      - name: Validate required files
        id: validation
        run: |
          echo "Validating deployment package..."
          required_files=(
            "scripts/host-camera-capture.py"
            "deployment/host-camera-capture.service"
            "deployment/deploy.sh"
            "docker-compose.yml"
          )
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          python3 -m py_compile scripts/host-camera-capture.py
          echo "Validating docker-compose configuration..."
          docker compose -f docker-compose.yml config > /dev/null
          if ! docker compose -f docker-compose.yml config | grep -q "redis:"; then
            echo "âŒ Redis service not found in docker-compose.yml"
            exit 1
          fi
          echo "Validating Redis dependencies..."
          if ! grep -q "redis" edge_processing/requirements-cloud.txt; then
            echo "âŒ Redis not found in edge_processing requirements"
            exit 1
          fi
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "âœ… Deployment package validation passed (including Redis)"

  build_and_deploy:
    name: Build Docker Image and Deploy to Raspberry Pi
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.deployment-ready == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push Docker image (arm64)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: gcumerk/cst590-capstone-public:latest
          platforms: linux/arm64
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.PI_SSH_KEY }}
      - name: Add Pi to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts
      - name: Copy deployment files to Pi
        run: |
          echo "ğŸ“¦ Copying deployment files to Raspberry Pi..."
          ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p ~/deployment-staging"
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='documentation/' \
            --exclude='*.md' \
            --exclude='test_*' \
            --exclude='__pycache__/' \
            ./ $DEPLOY_USER@$DEPLOY_HOST:~/deployment-staging/
      - name: Execute deployment on Pi
        id: deploy
        run: |
          echo "ğŸš€ Executing deployment on Raspberry Pi..."
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            set -e
            cd ~/deployment-staging
            chmod +x deployment/deploy.sh
            ./deployment/deploy.sh 2>&1 | tee deployment.log
          EOF
      - name: Validate deployment
        if: steps.deploy.outcome == 'success'
        run: |
          echo "ğŸ” Validating deployment..."
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            set -e
            if ! systemctl is-active --quiet host-camera-capture; then
              echo "âŒ Host camera service not running"
              systemctl status host-camera-capture --no-pager
              exit 1
            fi
            echo "âœ… Host camera service is running"
            cd ~/deployment-staging
            echo "ğŸ” Checking container status..."
            docker-compose ps
            if ! docker-compose ps | grep -q "Up"; then
              echo "âŒ Containers not running properly"
              docker-compose ps
              exit 1
            fi
            echo "âœ… Containers are running"
            echo "ğŸ” Checking Redis service..."
            if ! docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
              echo "âŒ Redis service not responding"
              docker-compose logs redis
              exit 1
            fi
            echo "âœ… Redis service is responding"
            echo "ğŸ” Testing Redis connectivity from main service..."
            sleep 5
            if ! docker-compose logs traffic-monitor | grep -q "Connected to Redis\|Redis"; then
              echo "âš ï¸ No Redis connection logs found (may still be connecting)"
            else
              echo "âœ… Traffic monitor connected to Redis"
            fi
            echo "ğŸ” Testing API endpoint..."
            sleep 10
            if ! curl -f -s http://localhost:5000/api/health >/dev/null; then
              echo "âš ï¸ API not responding immediately (may need more time)"
            else
              echo "âœ… API is responding"
            fi
            echo "ğŸ‰ Deployment validation completed (Redis + API + Host Service)"
          EOF
      - name: Cleanup staging files
        if: always()
        run: |
          ssh $DEPLOY_USER@$DEPLOY_HOST "rm -rf ~/deployment-staging"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate, build_and_deploy]
    if: always()
    steps:
      - name: Deployment Success Notification
        if: needs.build_and_deploy.result == 'success'
        run: |
          echo "âœ… Traffic Monitoring System deployed successfully!"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
      - name: Deployment Failure Notification
        if: needs.build_and_deploy.result == 'failure' || needs.validate.result == 'failure'
        run: |
          echo "âŒ Traffic Monitoring System deployment failed!"
          echo "ğŸŒ Environment: production"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          exit 1
