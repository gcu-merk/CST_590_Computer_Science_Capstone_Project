#!/bin/bash
# Post-Deployment Maintenance Verification Script
# Run this on your Raspberry Pi after CI/CD deployment to verify maintenance system
#
# Note: Containers are resolved at runtime from docker compose services when available.
# Services referenced by this script:
#   - Main service: traffic-monitor
#   - Maintenance service: data-maintenance

echo "üîç Verifying Automated Maintenance System Deployment"
echo "=================================================="
echo "Time: $(date)"
echo ""

# Check if we're in the deployment directory
DEPLOY_DIR="/mnt/storage/traffic-monitor-deploy"
if [ -d "$DEPLOY_DIR" ]; then
    cd "$DEPLOY_DIR"
    echo "üìÅ Working from deployment directory: $DEPLOY_DIR"
else
    echo "‚ö†Ô∏è  Deployment directory not found, using current directory"
fi

# Dynamic container name detection from docker-compose.yml if available
echo ""
echo "üîç Detecting container configuration..."
MAIN_CONTAINER=""
MAINTENANCE_CONTAINER_NAMES=""

# Helper: resolve container name from compose service
resolve_compose_service_name() {
    local svc="$1"
    # Prefer docker compose v2 command, fallback to docker-compose
    local cid
    cid=$(docker compose ps -q "$svc" 2>/dev/null || docker-compose ps -q "$svc" 2>/dev/null)
    if [ -n "$cid" ]; then
        # Get the container name as displayed by docker
        echo $(docker inspect --format='{{.Name}}' "$cid" 2>/dev/null | sed 's/^\///')
        return 0
    fi
    return 1
}

echo ""
echo "üîç Detecting container configuration..."
if [ -f "docker-compose.yml" ]; then
    echo "üìã Found docker-compose.yml, resolving service container names via docker compose..."
    MAIN_CONTAINER=$(resolve_compose_service_name "traffic-monitor" || true)
    MAINTENANCE_SERVICE_CONTAINER=$(resolve_compose_service_name "data-maintenance" || true)

    # Fallbacks if resolution failed
    MAIN_CONTAINER=${MAIN_CONTAINER:-traffic-monitor}
    MAINTENANCE_SERVICE_CONTAINER=${MAINTENANCE_SERVICE_CONTAINER:-data-maintenance}

    echo "   Main container: $MAIN_CONTAINER"
    echo "   Maintenance container (candidate): $MAINTENANCE_SERVICE_CONTAINER"
    # Build a list of candidate maintenance container names to check
    MAINTENANCE_CONTAINER_NAMES="$MAINTENANCE_SERVICE_CONTAINER data-maintenance"
else
    echo "‚ö†Ô∏è  No docker-compose.yml found, using default container name patterns"
    # Legacy fallback names kept for older deployments
    MAIN_CONTAINER="traffic-monitor"
    MAINTENANCE_CONTAINER_NAMES="data-maintenance"
fi

echo ""
echo "üê≥ Container Status Check"
echo "------------------------"

# Check if both containers are running
echo "All containers:"
docker compose ps --format "table {{.Service}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo ""
echo "Maintenance service specific:"
# Check for any of the candidate maintenance container names to be more robust
MAINT_PATTERN=$(echo $MAINTENANCE_CONTAINER_NAMES | tr ' ' '|')
if docker ps | grep -q -E "($MAINT_PATTERN).*Up"; then
    echo "‚úÖ Maintenance service: Running"
    # Show which container is running
    ACTIVE_MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "($MAINT_PATTERN)" | head -1)
    echo "   Container: $ACTIVE_MAINTENANCE_CONTAINER"
else
    echo "‚ùå Maintenance service: Not running"
    echo "Checking logs..."
    for container in $MAINTENANCE_CONTAINER_NAMES; do
        docker logs "$container" 2>/dev/null | tail -10 && break
    done || echo "No maintenance container logs found"
fi

echo ""
echo "üîß Maintenance System Verification"
echo "-----------------------------------"

# Test maintenance script availability
if docker exec "$MAIN_CONTAINER" test -f /mnt/storage/scripts/container-maintenance.py 2>/dev/null; then
    echo "‚úÖ Maintenance scripts: Available in main container"
    
    # Test maintenance status
    echo ""
    echo "üìä Current maintenance status:"
    docker exec "$MAIN_CONTAINER" python3 /mnt/storage/scripts/container-maintenance.py --status 2>/dev/null | head -20 || echo "‚ùå Status check failed"
    
else
    echo "‚ùå Maintenance scripts: Not found in container"
    echo "   The maintenance system may not be included in the Docker image yet"
fi

# Check if any maintenance service container has scripts
if docker ps | grep -q -E "($MAINT_PATTERN)"; then
    MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "($MAINT_PATTERN)" | head -1)
    echo ""
    echo "üìä Maintenance service status ($MAINTENANCE_CONTAINER):"
    docker exec "$MAINTENANCE_CONTAINER" python3 /mnt/storage/scripts/container-maintenance.py --status 2>/dev/null | head -20 || echo "‚ùå Maintenance service status check failed"
fi

echo ""
echo "üíæ Storage Configuration Check"
echo "------------------------------"

# Check SSD mount
if mountpoint -q /mnt/storage; then
    echo "‚úÖ SSD mounted at /mnt/storage"
    echo "   Usage: $(df -h /mnt/storage | tail -1 | awk '{print $5}') used of $(df -h /mnt/storage | tail -1 | awk '{print $2}')"
else
    echo "‚ùå SSD not mounted at /mnt/storage"
    echo "   Maintenance system requires SSD to be mounted"
fi

# Check camera directories
echo ""
echo "üì∏ Camera directories:"
for dir in "/mnt/storage/camera_capture/live" "/mnt/storage/camera_capture/processed" "/mnt/storage/periodic_snapshots"; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -name "*.jpg" 2>/dev/null | wc -l)
        echo "  ‚úÖ $dir: $count images"
    else
        echo "  ‚ùå $dir: Not found"
    fi
done

echo ""
echo "üìã Environment Variables Check"
echo "-----------------------------"

# Check maintenance environment variables in main container
echo "Maintenance configuration in main container:"
docker exec "$MAIN_CONTAINER" printenv | grep MAINTENANCE 2>/dev/null || echo "  No MAINTENANCE_* environment variables found"

# Check in maintenance service if it exists
if docker ps | grep -q -E "(data-maintenance)"; then
    MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "(data-maintenance)" | head -1)
    echo ""
    echo "Maintenance configuration in maintenance service ($MAINTENANCE_CONTAINER):"
    docker exec "$MAINTENANCE_CONTAINER" printenv | grep MAINTENANCE 2>/dev/null || echo "  No MAINTENANCE_* environment variables found"
fi

echo ""
echo "üïê Scheduled Maintenance Check"
echo "-----------------------------"

# Check if cron is available in containers
if docker exec "$MAIN_CONTAINER" which cron >/dev/null 2>&1; then
    echo "‚úÖ Cron available in main container"
    echo "Cron jobs:"
    docker exec "$MAIN_CONTAINER" crontab -l 2>/dev/null || echo "  No cron jobs configured"
else
    echo "‚ùå Cron not available in main container"
fi

if docker ps | grep -q -E "($MAINT_PATTERN)"; then
    MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "($MAINT_PATTERN)" | head -1)
    if docker exec "$MAINTENANCE_CONTAINER" which cron >/dev/null 2>&1; then
        echo "‚úÖ Cron available in maintenance service ($MAINTENANCE_CONTAINER)"
        echo "Cron jobs:"
        docker exec "$MAINTENANCE_CONTAINER" crontab -l 2>/dev/null || echo "  No cron jobs configured"
    else
        echo "‚ÑπÔ∏è  Cron not available in maintenance service ($MAINTENANCE_CONTAINER) - using daemon mode instead"
    fi
fi

echo ""
echo "üöÄ Manual Maintenance Test"
echo "-------------------------"

# Test manual maintenance execution
echo "Testing manual maintenance execution..."
MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "($MAINT_PATTERN)" | head -1)

if docker exec "$MAIN_CONTAINER" python3 /mnt/storage/scripts/container-maintenance.py --status >/dev/null 2>&1; then
    echo "‚úÖ Manual maintenance execution: Working (main container)"
    echo ""
    echo "üßπ You can run manual maintenance with:"
    echo "  docker exec $MAIN_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --daily-cleanup"
    echo "  docker exec $MAIN_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --emergency-cleanup"
elif [ -n "$MAINTENANCE_CONTAINER" ] && docker exec "$MAINTENANCE_CONTAINER" python3 /mnt/storage/scripts/container-maintenance.py --status >/dev/null 2>&1; then
    echo "‚úÖ Manual maintenance execution: Working (via maintenance service: $MAINTENANCE_CONTAINER)"
    echo ""
    echo "üßπ You can run manual maintenance with:"
    echo "  docker exec $MAINTENANCE_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --daily-cleanup"
    echo "  docker exec $MAINTENANCE_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --emergency-cleanup"
else
    echo "‚ùå Manual maintenance execution: Failed"
    echo "   Check if maintenance scripts are included in Docker image"
fi

echo ""
echo "üìä Next Steps"
echo "============"

# Determine what needs to be done based on findings
MAINTENANCE_CONTAINER=$(docker ps --format "{{.Names}}" | grep -E "($MAINT_PATTERN)" | head -1)

# Check if both main container has scripts AND maintenance service is running
MAIN_HAS_SCRIPTS=$(docker exec "$MAIN_CONTAINER" test -f /mnt/storage/scripts/container-maintenance.py 2>/dev/null && echo "true" || echo "false")
MAINTENANCE_SERVICE_RUNNING=$([ -n "$MAINTENANCE_CONTAINER" ] && docker ps | grep -q -E "($MAINT_PATTERN).*Up" && echo "true" || echo "false")

if [ "$MAIN_HAS_SCRIPTS" = "true" ] && [ "$MAINTENANCE_SERVICE_RUNNING" = "true" ]; then
    echo "üéâ OPTIMAL: Dual-Container Maintenance System Fully Operational!"
    echo ""
    echo "‚úÖ What's working:"
    echo "  ‚Ä¢ Main container ($MAIN_CONTAINER): Has maintenance scripts"
    echo "  ‚Ä¢ Dedicated service ($MAINTENANCE_CONTAINER): Running in daemon mode"
    echo "  ‚Ä¢ Dual redundancy: Maintenance available in both containers"
    echo "  ‚Ä¢ Manual operations: Available via both containers"
    echo ""
    echo "üïê Automatic schedule (via $MAINTENANCE_CONTAINER):"
    echo "  ‚Ä¢ Daemon mode: Continuous monitoring and maintenance"
    echo "  ‚Ä¢ Background cleanup: As needed based on thresholds"
    echo "  ‚Ä¢ Storage monitoring: Real-time space management"
    echo ""
    echo "üìä Monitor with:"
    echo "  docker logs $MAINTENANCE_CONTAINER -f"
    echo "  docker exec $MAINTENANCE_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --status"
    
elif [ "$MAINTENANCE_SERVICE_RUNNING" = "true" ] && [ -n "$MAINTENANCE_CONTAINER" ]; then
    echo "üéâ Maintenance service is fully operational!"
    echo ""
    echo "‚úÖ What's working:"
    echo "  ‚Ä¢ Maintenance service ($MAINTENANCE_CONTAINER) is running"
    echo "  ‚Ä¢ Scripts are accessible"
    echo "  ‚Ä¢ Manual operations available"
    echo ""
    echo "üïê Automatic schedule:"
    echo "  ‚Ä¢ Daemon mode: Continuous monitoring"
    echo "  ‚Ä¢ Background cleanup: As needed"
    echo "  ‚Ä¢ Storage monitoring: Real-time"
    echo ""
    echo "üìä Monitor with:"
    echo "  docker logs $MAINTENANCE_CONTAINER -f"
    echo "  docker exec $MAINTENANCE_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --status"
    
elif docker exec "$MAIN_CONTAINER" test -f /mnt/storage/scripts/container-maintenance.py 2>/dev/null; then
    echo "‚ö†Ô∏è  Single-container deployment detected"
    echo ""
    echo "‚úÖ Maintenance scripts are in main container"
    echo "‚ùå Dedicated maintenance service not running"
    echo ""
    echo "üîß To enable full maintenance:"
    echo "  1. Check if docker-compose.yml includes maintenance service"
    echo "  2. Restart deployment: docker compose down && docker compose up -d"
    echo ""
    echo "üßπ For now, you can run manual maintenance:" 
    echo "  docker exec $MAIN_CONTAINER python3 /mnt/storage/scripts/container-maintenance.py --daily-cleanup"
    
else
    echo "‚ùå Maintenance system not detected"
    echo ""
    echo "Possible issues:"
    echo "  ‚Ä¢ Docker image doesn't include maintenance scripts yet"
    echo "  ‚Ä¢ CI/CD hasn't deployed latest changes"
    echo "  ‚Ä¢ Docker image needs to be rebuilt with maintenance files"
    echo ""
    echo "üîß Solutions:"
    echo "  1. Wait for next CI/CD deployment cycle"
    echo "  2. Trigger manual deployment if available"
    echo "  3. Check GitHub Actions for build/deployment status"
fi

echo ""
echo "üîç View full status anytime with:"
echo "  bash verify-maintenance-deployment.sh"